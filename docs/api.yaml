openapi: 3.0.3

info:
  title: IoT Hub API
  version: "1.4.1"
  description: |
    API for managing devices, telemetry, and rules with full CRUD support, JWT authentication,
    pagination, schema versioning, and example payloads for testing.

servers:
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Authentication
    description: Authentication endpoints
  - name: Devices
    description: CRUD operations for devices
  - name: Telemetry
    description: CRUD operations for telemetry
  - name: Rules
    description: Business logic rules and event management
  - name: Events
    description: Events triggered by rules


paths:
  /api/auth/login/:
    post:
      tags:
        - Authentication
      operationId: authLogin
      summary: Obtain JWT access token
      description: |
        Authenticates a user and returns a JWT access token.
        The token must be used in the `Authorization` header for all protected endpoints.
      security: []
      requestBody:
        required: true
        description: User credentials
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
            examples:
              valid_credentials:
                summary: Valid user credentials
                value:
                  username: testuser
                  password: testpassword
              admin_credentials:
                summary: Valid admin credentials
                value:
                  username: adminuser
                  password: adminpassword
      responses:
        '200':
          description: JWT token issued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
              examples:
                success:
                  summary: Access token response
                  value:
                    access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                    token_type: bearer
                    expires_in: "2026-01-22T17:00:00Z"
        '400':
          description: Invalid JSON or invalid request payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_json:
                  summary: Invalid JSON
                  value:
                    code: 400
                    message: "Malformed JSON payload."
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_credentials:
                  summary: Username or password is incorrect
                  value:
                    code: 401
                    message: "Invalid username or password."
        '422':
          description: Validation error (missing or invalid fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_password:
                  summary: Password is missing
                  value:
                    code: 422
                    message: "password: This field is required."

  /api/auth/refresh/:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Exchanges a valid refresh token for a new access token.
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRefreshRequest'
            examples:
              valid_refresh:
                summary: Valid refresh token
                value:
                  refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              empty_refresh:
                summary: Empty refresh token (invalid)
                value:
                  refresh_token: ""
      responses:
        '200':
          description: Access token refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
              examples:
                success:
                  value:
                    access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                    token_type: bearer
                    expires_in: "2026-04-28T16:15:01Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_refresh:
                  value:
                    detail: "Invalid refresh token."
        '401':
          description: Unauthorized (refresh token expired or revoked)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                expired:
                  value:
                    detail: "Token is expired."

        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  value:
                    detail: "refresh_token is required."

  /api/devices/:
    get:
      tags:
        - Devices
      operationId: listDevices
      summary: List devices with pagination
      description: Retrieve a paginated list of devices in the system.
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 5
          description: Maximum number of devices to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip
      responses:
        '200':
          description: List of devices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedDevices'
              examples:
                sample:
                  value:
                    total: 2
                    limit: 5
                    offset: 0
                    items:
                      - id: 1
                        serial_id: "ABC12345"
                        name: "Smoke detector"
                        description: "A device that monitors smoke levels"
                        user_id: 1
                        is_active: true
                        created_at: "2026-01-22T12:00:00Z"
                      - id: 2
                        serial_id: "QWE12345"
                        name: "Humidity meter"
                        description: "A device that monitors humidity levels"
                        user_id: 1
                        is_active: false
                        created_at: "2026-01-22T14:32:54Z"
        '404':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "Devices not found"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  value:
                    code: 401
                    message: "Unauthorized"
    post:
      tags:
        - Devices
      operationId: createDevice
      summary: Create a new device
      description: Create a new device with the provided data. The device must include required fields and schema version.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDeviceCreate'
            examples:
              new_device:
                value:
                  schema_version: "v1"
                  device:
                    serial_id: "DEF12345"
                    name: "Digital thermometer"
                    description: "Monitors indoor temperature"
                    user_id: 1
                    is_active: false
      responses:
        '201':
          description: Device created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
              examples:
                created:
                  value:
                    id: 3
                    serial_id: "DEF12345"
                    name: "Digital thermometer"
                    description: "Monitors indoor temperature"
                    user_id: 1
                    is_active: false
                    created_at: "2026-02-09T16:00:00Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                bad_request:
                  value:
                    code: 400
                    message: "Invalid device data"

  /api/devices/{id}/:
    get:
      tags:
        - Devices
      operationId: getDeviceById
      summary: Get device by id
      description: Returns a single device by its unique identifier.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Device found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
              examples:
                example_device:
                  value:
                    id: 1
                    serial_id: "ABC12345"
                    name: "Smoke detector"
                    description: "Monitors CO2 levels."
                    user_id: 1
                    is_active: true
                    created_at: "2026-01-22T12:00:00Z"
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "Device not found."
    put:
      tags:
        - Devices
      operationId: replaceDevice
      summary: Replace device
      description: Fully replaces an existing device with the provided payload.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDeviceCreate'
            examples:
              replace_example:
                value:
                  schema_version: "v1"
                  device:
                    serial_id: "DEF12345"
                    name: "Digital thermometer"
                    description: "Monitors indoor temperature."
                    user_id: 1
                    is_active: false
      responses:
        '200':
          description: Device updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
              examples:
                updated_device:
                  value:
                    id: 1
                    serial_id: "DEF12345"
                    name: "Digital thermometer"
                    description: "Monitors indoor temperature."
                    user_id: 1
                    is_active: false
                    created_at: "2026-01-22T12:00:00Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  value:
                    code: 400
                    message: "Invalid device payload."
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "Device not found."
    patch:
      tags:
        - Devices
      summary: Partially update device
      description: Update one or more fields of an existing device.
      operationId: patchDevice
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDevicePatch'
            examples:
              patch_example:
                value:
                  schema_version: "v1"
                  device:
                    name: "Updated smoke detector"
                    is_active: true
      responses:
        '200':
          description: Device updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
              examples:
                patched_device:
                  value:
                    id: 1
                    serial_id: "ABC12345"
                    name: "Updated smoke detector"
                    description: "Monitors CO2 levels."
                    user_id: 1
                    is_active: true
                    created_at: "2026-01-22T12:00:00Z"
        '400':
          description: Invalid patch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_patch:
                  value:
                    code: 400
                    message: "Invalid fields for patch."
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "Device not found."
    delete:
      tags:
        - Devices
      summary: Delete device
      description: Deletes a device by its ID.
      operationId: deleteDevice
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        '204':
          description: Device deleted successfully
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "Device not found."

  /api/telemetry/:
    get:
      tags:
        - Telemetry
      summary: List telemetry records by device_id with pagination
      description: Returns a paginated list of telemetry records for a given device.
      operationId: listTelemetry
      security:
        - BearerAuth: []
      parameters:
        - name: device_id
          in: query
          required: true
          schema:
            type: integer
            example: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 5
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of telemetry records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTelemetry'
              examples:
                example_page:
                  value:
                    total: 2
                    limit: 5
                    offset: 0
                    items:
                      - id: 1
                        device_id: 1
                        metric: "temperature"
                        value: 23.5
                        ts: "2026-02-09T12:00:00Z"
                      - id: 2
                        device_id: 1
                        metric: "temperature"
                        value: 24.0
                        ts: "2026-02-09T12:05:00Z"

        '404':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    code: 404
                    message: "No telemetry records found."
    post:
      tags:
        - Telemetry
      summary: Ingest telemetry (single or batch)
      description: Adds a new telemetry record for a device.
      operationId: ingestTelemetry
      security:
        - BearerAuth: [ ]
      parameters:
        - in: header
          name: Ingest-Async
          description: "If set to 1, ingestion is queued via Celery and returns 202."
          required: false
          schema:
            type: string
            enum: [ "1" ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/TelemetryIngest"
                - $ref: "#/components/schemas/TelemetryIngestBatch"
            examples:
              single:
                summary: Single telemetry payload
                value:
                  schema_version: 1
                  device: "DEV-001"
                  ts: "2026-02-04T12:00:00Z"
                  metrics:
                    temperature: 21.5
                    door_open: false
                    status: "ok"
              batch:
                summary: Batch telemetry payload
                value:
                  - schema_version: 1
                    device: "DEV-001"
                    ts: "2026-02-04T12:00:00Z"
                    metrics:
                      temperature: 21.5
                  - schema_version: 1
                    device: "DEV-001"
                    ts: "2026-02-04T12:00:01Z"
                    metrics:
                      temperature: 21.6
      responses:
        '201':
          description: Telemetry ingested
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/TelemetryIngestSingleResponse"
                  - $ref: "#/components/schemas/TelemetryIngestBatchResponse"
              examples:
                single_ok:
                  summary: Single payload accepted
                  value:
                    status: "ok"
                    created: 3
                    errors: { }
                batch_ok:
                  summary: Batch payload accepted
                  value:
                    status: "ok"
                    created: 4
                    items:
                      - created: 2
                        errors: { }
                      - created: 2
                        errors: { }
                    errors: { }
        '202':
          description: Accepted for async ingestion
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TelemetryIngestAsyncResponse"
              examples:
                queued:
                  value:
                    status: "accepted"
                    task_id: "c1b6d6d2-3f10-4d77-a5d7-6a4b8a1f2c9e"


        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  value:
                    code: 400
                    message: "Invalid telemetry payload."

  # Note: The following endpoints for /api/telemetry/{id} are defined but commented out to focus on the more critical paths for testing. They can be uncommented and implemented later as needed.
  # /api/telemetry/{id}:
  #   get:
  #     tags:
  #       - Telemetry
  #     summary: Get telemetry by id
  #     description: Returns a telemetry record by its unique ID.
  #     operationId: getTelemetryById
  #     security:
  #       - BearerAuth: []
  #     parameters:
  #       - name: id
  #         in: path
  #         required: true
  #         schema:
  #           type: integer
  #           example: 1
  #     responses:
  #       '200':
  #         description: Telemetry found
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/Telemetry'
  #             examples:
  #               example_telemetry:
  #                 value:
  #                   id: 1
  #                   device_id: 1
  #                   value: 23.5
  #                   timestamp: "2026-02-09T12:00:00Z"
  #       '404':
  #         description: Telemetry not found
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #             examples:
  #               not_found:
  #                 value:
  #                   code: 404
  #                   message: "Telemetry record not found."
  #   put:
  #     tags:
  #       - Telemetry
  #     summary: Replace telemetry
  #     description: Fully replaces an existing telemetry record.
  #     operationId: replaceTelemetry
  #     security:
  #       - BearerAuth: []
  #     parameters:
  #       - name: id
  #         in: path
  #         required: true
  #         schema:
  #           type: integer
  #           example: 1
  #     requestBody:
  #       required: true
  #       content:
  #         application/json:
  #           schema:
  #             $ref: '#/components/schemas/VersionedTelemetryCreate'
  #           examples:
  #             replace_telemetry:
  #               value:
  #                 schema_version: "v1"
  #                 telemetry:
  #                   device_id: 1
  #                   value: 24.0
  #     responses:
  #       '200':
  #         description: Telemetry updated
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/Telemetry'
  #       '400':
  #         description: Invalid request
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #       '404':
  #         description: Telemetry not found
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #   patch:
  #     tags:
  #       - Telemetry
  #     summary: Partially update telemetry
  #     operationId: patchTelemetry
  #     security:
  #       - BearerAuth: []
  #     parameters:
  #       - name: id
  #         in: path
  #         required: true
  #         schema:
  #           type: integer
  #     requestBody:
  #       required: true
  #       content:
  #         application/json:
  #           schema:
  #             $ref: '#/components/schemas/VersionedTelemetryPatch'
  #     responses:
  #       '200':
  #         description: Telemetry updated
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/Telemetry'
  #       '400':
  #         description: Invalid patch
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #       '404':
  #         description: Telemetry not found
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #   delete:
  #     tags:
  #       - Telemetry
  #     summary: Delete telemetry
  #     description: Deletes a telemetry record by ID.
  #     operationId: deleteTelemetry
  #     security:
  #       - BearerAuth: []
  #     parameters:
  #       - name: id
  #         in: path
  #         required: true
  #         schema:
  #           type: integer
  #           example: 1 
  #     responses:
  #       '204':
  #         description: Telemetry deleted successfully
  #       '404':
  #         description: Telemetry not found
  #         content:
  #           application/json:
  #             schema:
  #               $ref: '#/components/schemas/ErrorResponse'
  #             examples:
  #               not_found:
  #                 value:
  #                   code: 404
  #                   message: "Telemetry record not found."

  /api/rules/:
    get:
      tags:
        - Rules
      operationId: listRules
      summary: List rules with pagination and filters
      description: |
        Returns a paginated list of rules.
        Supports filtering by activation status and action type.
        Used to browse, search, and manage existing rules.
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of rules to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip
        - name: is_active
          in: query
          schema:
            type: boolean
          description: Filter by enabled status
        - name: action
          in: query
          schema:
            type: object
          description: Filter by action type in JSON format
          example:
            webhook:
              url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
              enabled: true
            notification:
              channel: "email"
              enabled: true
              message: "High temperature in {device_name}: {value}°C"
      responses:
        '200':
          description: List of rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedRules'
              examples:
                default:
                  summary: Paginated list of rules
                  value:
                    total: 3
                    limit: 20
                    offset: 0
                    items:
                      - id: 12
                        name: "High Temperature Alert"
                        description: "Alert when temperature exceeds 30°C"
                        is_active: true
                        condition:
                          type: "threshold"
                          operator: ">"
                          value: 30
                        action:
                          webhook:
                            url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                            enabled: true
                          notification:
                            channel: "email"
                            enabled: true
                            message: "High temperature in {device_name}: {value}°C"
                        device_metric_id: 1
                      - schema_version: 1
                        id: 32
                        name: "Low Humidity Alert"
                        description: "Alert when humidity drops below 20%"
                        is_active: true
                        condition:
                          type: "threshold"
                          operator: "<"
                          value: 20
                        action:
                          webhook:
                            url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                            enabled: true
                          notification:
                            channel: "email"
                            enabled: true
                            message: "High temperature in {device_name}: {value}°C"
                        device_metric_id: 1
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_filter:
                  summary: Invalid query parameters
                  value:
                    code: 400
                    message: "Invalid filter parameters"
    post:
      tags:
        - Rules
      operationId: createRule
      summary: Create a new rule
      description:  |
        Creates a new rule and persists it for future evaluation.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreate'
            examples:
              threshold_rule:
                summary: Temperature threshold rule
                value:
                  schema_version: 1
                  name: "High Temperature Alert"
                  description: "Alert when temperature exceeds 30°C"
                  is_active: true
                  condition:
                    type: "threshold"
                    operator: ">"
                    value: 30
                  action:
                    webhook:
                      url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                      enabled: true
                    notification:
                      channel: "email"
                      enabled: true
                      message: "High temperature in {device_name}: {value}°C"
                  device_metric_id: 1
              rate_rule:
                summary: Event rate rule
                value:
                  schema_version: 1
                  name: "Too Many Errors"
                  description: "Alert when more than 10 errors occur in 5 minutes"
                  is_active: true
                  condition:
                    type: "rate"
                    count: 10
                    minutes: 300
                  action:
                    webhook:
                      url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                      enabled: true
                    notification:
                      channel: "email"
                      enabled: true
                      message: "High temperature in {device_name}: {value}°C"
                  device_metric_id: 2
              composite_rule:
                summary: Composite AND rule
                value:
                  schema_version: 1
                  name: "Critical System State"
                  description: "Alert when temperature high AND humidity low"
                  is_active: true
                  condition:
                    type: "composite"
                    operator: "AND"
                    conditions:
                      - type: "threshold"
                        operator: ">"
                        value: 35
                        device_metric_id: 1
                      - type: "threshold"
                        device_metric_id: 2
                        operator: "<"
                        value: 20
                  action:
                    webhook:
                      url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                      enabled: true
                    notification:
                      channel: "email"
                      enabled: true
                      message: "High temperature in {device_name}: {value}°C"
                  device_metric_id: 1
      responses:
        '201':
          description: Rule created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                created:
                  summary: Created rule with full schema
                  value:
                    schema_version: 1
                    id: 22
                    name: "High Temperature Alert"
                    description: "Alert when temperature exceeds 30°C"
                    is_active: true
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 30
                    action:
                      webhook:
                        url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                        enabled: true
                      notification:
                        channel: "email"
                        enabled: true
                        message: "High temperature in {device_name}: {value}°C"
                    device_metric_id: 1
        '400':
          description: Invalid rule definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_condition:
                  summary: Invalid condition definition
                  value:
                    code: 400
                    message: "Invalid rule condition: Unsupported operator"     

  /api/rules/{id}/:
    get:
      tags:
        - Rules
      operationId: getRuleById
      summary: Get rule by ID
      description: |
        Returns full rule details by its unique identifier.
        Includes condition definition, action configuration, and current state.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer  
      responses:
        '200':
          description: Rule found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    schema_version: 1
                    id: 31
                    name: "Updated Rule"
                    is_active: false
                    action:
                      webhook:
                        url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                        enabled: true
                      notification:
                        channel: "email"
                        enabled: true
                        message: "High temperature in {device_name}: {value}°C"
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric_id: 2  
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400   
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    put:
      tags:
        - Rules
      operationId: replaceRule
      summary: Replace rule completely
      description: |
        Replaces the entire rule definition.
        All rule fields must be provided in the request body.
        Missing fields will be overwritten with new values.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreate'
            examples:
              update_example:
                summary: Update rule example
                value:
                  schema_version: 1
                  name: "Updated Rule"
                  description: "Changed description"
                  is_active: false
                  condition:
                    type: "threshold"
                    operator: ">"
                    value: 13
                  action:
                    webhook:
                      url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                      enabled: true
                    notification:
                      channel: "email"
                      enabled: true
                      message: "High temperature in {device_name}: {value}°C"
                  device_metric_id: 2
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    schema_version: 1
                    id: 44
                    name: "Updated Rule"
                    is_active: false
                    action:
                      webhook:
                        url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                        enabled: true
                      notification:
                        channel: "email"
                        enabled: true
                        message: "High temperature in {device_name}: {value}°C"
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric_id: 1   
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    patch:
      tags:
        - Rules
      summary: Partially update rule
      description: |
        Updates one or more fields of an existing rule.
        Only provided fields are modified; all others remain unchanged.
      operationId: patchRule
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RulePatch'
            examples:
              replace_rule:
                summary: Full rule replacement
                value:
                  schema_version: 1
                  name: "Updated Rule"
                  is_active: false
                  condition:
                    type: "threshold"
                    operator: "<"
                    value: 10
                  device_metric_id: 1
                  action:
                    webhook:
                      url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                      enabled: true
                    notification:
                      channel: "email"
                      enabled: true
                      message: "High temperature in {device_name}: {value}°C"
  
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleUpdateResponse'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    status: 200
                    rule_id: 1  
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    delete:
      tags:
        - Rules
      summary: Delete rule
      description: |
        Permanently deletes a rule.
        Deleted rules are no longer evaluated and cannot be restored.
      operationId: deleteRule
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Rule deleted
          content:
            application/json:
              examples:
                no_content:
                  summary: No response body
                  value: {}
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule does not exist
                  value:
                    code: 404
                    message: "Rule not found"

  /api/rules/evaluate/:
    post:
      tags:
        - Rules
      summary: Manually trigger rule evaluation
      operationId: evaluateRules
      description: |
        Triggers manual evaluation of all enabled rules for debugging and demo purposes.
        This endpoint runs the rule processor immediately instead of waiting for the scheduled task.
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleEvaluateRequest'
            examples:
              evaluate_example:
                summary: Evaluate telemetry data against rules
                value:
                  device_id: 9
      responses:
        '200':
          description: Evaluation results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/RuleEvaluationResult'
              example:
                status: 200
                results:
                  - telemetry_id: 2
                    device_metric_id: 1
                    device_name: "device 1"
                    result:
                      telemetry_id: 2
                      results:
                        - rule_id: 1
                          triggered: true
                        - rule_id: 4
                          triggered: true        
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  summary: Invalid telemetry payload
                  value:
                    code: 400
                    message: "Telemetry value missing"

  /api/events/:
    get:
      tags:
        - Events
      operationId: listEvents
      summary: List events
      description: Retrieve a paginated list of events. Supports filtering by rule_id, device_id, acknowledged, and severity (reserved).
      security:
        - BearerAuth: []
      parameters:
        - name: rule_id
          in: query
          description: Filter events by rule ID
          required: false
          schema:
            type: integer
            minimum: 1
        - name: device_id
          in: query
          description: Filter events by trigger device ID
          required: false
          schema:
            type: integer
            minimum: 1
        - name: acknowledged
          in: query
          description: Filter events by acknowledgment status
          required: false
          schema:
            type: boolean
        - name: severity
          in: query
          description: Filter events by severity (currently reserved, not implemented)
          required: false
          schema:
            type: string
        - name: limit
          in: query
          description: Number of events to return (max 200)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - name: offset
          in: query
          description: Number of events to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: A paginated list of events
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    description: Total number of events
                  limit:
                    type: integer
                  offset:
                    type: integer
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
              example:
                count: 2
                limit: 50
                offset: 0
                results:
                  - id: 123
                    timestamp: "2026-01-25T09:53:00+00:00"
                    created_at: "2026-01-25T09:55:00+00:00"
                    acknowledged: false
                    rule:
                      id: 1
                      name: "High Temperature"
                    trigger_telemetry_id: 2
                    trigger_device_id: 1
                  - id: 124
                    timestamp: "2026-01-25T09:52:00+00:00"
                    created_at: "2026-01-25T09:53:00+00:00"
                    acknowledged: true
                    rule:
                      id: 2
                      name: "Low Battery"
                    trigger_telemetry_id: 43
                    trigger_device_id: 3
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  value:
                    code: 400
                    message: "Invalid query parameters."  

  /api/events/{event_id}/:
    get:
      tags:
        - Events
      operationId: getEventById
      summary: Retrieve event details
      description: Get detailed information about a single event by ID, including optional trigger telemetry info.
      security:
        - BearerAuth: []
      parameters:
        - name: event_id
          in: path
          required: true
          description: ID of the event
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
              example:
                id: 123
                timestamp: "2026-01-25T09:53:00+00:00"
                created_at: "2026-01-25T09:55:00+00:00"
                acknowledged: false
                rule:
                  id: 1
                  name: "High Temperature"
                trigger_telemetry_id: 2
                trigger_device_id: 1

        '404':
          description: Event not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
              example:
                detail: "Event not found"

  /api/events/{event_id}/ack/:
    post:
      tags:
        - Events
      operationId: acknowledgeEvent
      summary: Acknowledge an event
      description: Marks an event as acknowledged. Idempotent.
      security:
        - BearerAuth: []
      parameters:
        - name: event_id
          in: path
          required: true
          description: ID of the event
          schema:
            type: integer
            minimum: 1
      requestBody:
        description: No body required
        required: false
        content: { }
      responses:
        '200':
          description: Event acknowledged
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  event_id:
                    type: integer
                  acknowledged:
                    type: boolean
              example:
                example:
                id: 123
                timestamp: "2026-01-25T09:53:00+00:00"
                created_at: "2026-01-25T09:55:00+00:00"
                acknowledged: true
                rule:
                  id: 1
                  name: "High Temperature"
                trigger_telemetry_id: 2
                trigger_device_id: 1

        '404':
          description: Event not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
              example:
                detail: "Event not found"


components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token containing claims:
        - sub: authenticated user id
        - scope: granted permissions (e.g., devices:read)
        - role: user | admin
        - exp: expiration timestamp

  schemas:
    Device:
      type: object
      properties:
        id:
          type: integer
          example: 1
        serial_id:
          type: string
          example: "ABC12345"
        name:
          type: string
          example: "Smoke detector."
        description:
          type: string
          example: "A device that monitors smoke (CO2) levels in a building."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2026-01-22T12:00:00Z"
      required:
        - id
        - serial_id
        - name
        - user_id
        - is_active
        - created_at
      example:
        id: 1
        serial_id: "ABC12345"
        name: "Smoke detector."
        description: "A device that monitors smoke (CO2) levels in a building."
        user_id: 1
        is_active: true
        created_at: "2026-01-22T12:00:00Z"

    DeviceCreate:
      type: object
      properties:
        serial_id:
          type: string
          example: "DEF12345"
        name:
          type: string
          example: "Digital thermometer."
        description:
          type: string
          example: "Monitors indoor temperature."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: false
      required:
        - serial_id
        - name
        - user_id
        - is_active
      example:
        serial_id: "ABC12345"
        name: "Digital thermometer."
        description: "Monitors indoor temperature."
        user_id: 1
        is_active: false

    DevicePatch:
      type: object
      properties:
        serial_id:
          type: string
          example: "ABC12345"
        name:
          type: string
          example: "Smoke detector."
        description:
          type: string
          example: "New description."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: true
      example:
        serial_id: "ABC12345"
        name: "Smoke detector."
        description: "New description."
        user_id: 1
        is_active: true

    VersionedDeviceCreate:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1"
        device:
          $ref: '#/components/schemas/DeviceCreate'
      required:
        - schema_version
        - device
      example:
        schema_version: "v1"
        device:
          serial_id: "DEF12345"
          name: "Digital thermometer."
          description: "Monitors indoor temperature."
          user_id: 1
          is_active: false

    VersionedDevicePatch:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1"
        device:
          $ref: '#/components/schemas/DevicePatch'
      required:
        - schema_version
        - device
      example:
        schema_version: "v1"
        device:
          name: "Updated smoke detector name."
          description: "Updated description."
          is_active: true

    TelemetryMetricValue:
      oneOf:
        - type: boolean
          example: false
        - type: number
          example: 21.5
        - type: string
          example: "ok"
      example: 21.5

    Telemetry:
      type: object
      properties:
        id:
          type: integer
          example: 1
        device_id:
          type: integer
          example: 1
        metric:
          type: string
          example: "temperature"
        value:
          $ref: "#/components/schemas/TelemetryMetricValue"
        ts:
          type: string
          format: date-time
          example: "2024-04-13T18:45:37Z"
      required:
        - id
        - device_id
        - metric
        - value
        - ts
      example:
        id: 1
        device_id: 1
        metric: "temperature"
        value: 18.3
        ts: "2024-04-13T18:45:37Z"


    TelemetryIngest:
      type: object
      properties:
        schema_version:
          type: integer
          example: 1
        device:
          type: string
          example: "DEV-001"
        ts:
          type: string
          format: date-time
          example: "2026-02-04T12:00:00Z"
        metrics:
          type: object
          additionalProperties:
            $ref: "#/components/schemas/TelemetryMetricValue"
          example:
            temperature: 21.5
            door_open: false
            status: "ok"
      required:
        - schema_version
        - device
        - metrics
        - ts
      example:
        schema_version: 1
        device: "DEV-001"
        ts: "2026-02-04T12:00:00Z"
        metrics:
          temperature: 21.5
          door_open: false
          status: "ok"

    TelemetryIngestBatch:
      type: array
      items:
        $ref: "#/components/schemas/TelemetryIngest"
      example:
        - schema_version: 1
          device: "DEV-001"
          ts: "2026-02-04T12:00:00Z"
          metrics:
            temperature: 21.5
            door_open: false
        - schema_version: 1
          device: "DEV-001"
          ts: "2026-02-04T12:00:01Z"
          metrics:
            temperature: 21.6
            status: "ok"

    TelemetryIngestSingleResponse:
      type: object
      additionalProperties: false
      properties:
        status:
          type: string
          enum: [ "ok", "rejected" ]
          example: "ok"
        created:
          type: integer
          example: 3
        errors:
          type: object
          additionalProperties: true
          example: { }
      required:
        - status
        - created
        - errors
      example:
        status: "ok"
        created: 3
        errors: { }

    TelemetryIngestBatchItemResult:
      type: object
      additionalProperties: false
      properties:
        created:
          type: integer
          example: 2
        errors:
          type: object
          additionalProperties: true
          example: { }
      required:
        - created
        - errors
      example:
        created: 2
        errors: { }

    TelemetryIngestBatchResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ "ok", "rejected" ]
          example: "ok"
        created:
          type: integer
          example: 4
        items:
          type: array
          items:
            $ref: "#/components/schemas/TelemetryIngestBatchItemResult"
        errors:
          description: Item-level validation errors keyed by item index.
          type: object
          additionalProperties: true
          example:
            '1':
              device: "device must be of type str."
      required:
        - status
        - created
        - items
        - errors
      example:
        status: "ok"
        created: 4
        items:
          - created: 2
            errors: { }
          - created: 2
            errors: { }
        errors: { }

    TelemetryIngestAsyncResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ "accepted" ]
          example: "accepted"
      required:
        - status
      example:
        status: "accepted"

    # TelemetryPatch:
    #   type: object
    #   properties:
    #     key:
    #       type: string
    #       example: "temperature"
    #     value:
    #       type: number
    #       example: 24.3
    #   example:
    #     key: "temperature"
    #     value: 24.3

    # VersionedTelemetryCreate:
    #   type: object
    #   properties:
    #     schema_version:
    #       type: string
    #       example: "v1"
    #     telemetry:
    #       $ref: '#/components/schemas/TelemetryCreate'
    #   required:
    #     - schema_version
    #     - telemetry
    #   example:
    #     schema_version: "v2"
    #     telemetry:
    #       device_id: 1
    #       key: "humidity"
    #       value: 25.43

    # VersionedTelemetryPatch:
    #   type: object
    #   properties:
    #     schema_version:
    #       type: string
    #       example: "v1.0"
    #     telemetry:
    #       $ref: '#/components/schemas/TelemetryPatch'
    #   required:
    #     - schema_version
    #     - telemetry
    #   example:
    #     schema_version: "v1.2"
    #     telemetry:
    #       key: "temperature"
    #       value: 24.3

    AuthLoginRequest:
      type: object
      properties:
        username:
          type: string
          example: testuser
        password:
          type: string
          format: password
          example: testpassword
      required:
        - username
        - password
      example:
        username: testuser
        password: testpassword

    AuthTokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          example: bearer
        expires_in:
          type: string
          format: date-time
          example: "2026-01-22T17:00:00Z"
      required:
        - access_token
        - token_type
        - expires_in
      example:
        access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type: bearer
        expires_in: "2026-01-22T17:00:00Z"

    AuthRefreshRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: JWT refresh token
      example:
        refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        
    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      example:
        code: 404
        message: "Resource not found"

    PaginatedDevices:
      type: object
      properties:
        total:
          type: integer
          example: 12
        limit:
          type: integer
          example: 5
        offset:
          type: integer
          example: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/Device'
          example:
            [
              {
                id: 1,
                serial_id: "ABC12345",
                name: "Smoke detector.",
                description: "A device that monitors smoke (CO2) levels in a building.",
                user_id: 1,
                is_active: true,
                created_at: "2026-01-22T12:00:00Z"
              },
              {
                id: 2,
                serial_id: "QWE12345",
                name: "Humidity meter.",
                description: "A device that monitors humidity(%) level in a building.",
                user_id: 1,
                is_active: false,
                created_at: "2026-01-22T14:32:54Z"
              }
            ]
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 12
        limit: 5
        offset: 0
        items:
          - id: 1
            serial_id: "ABC12345"
            name: "Smoke detector."
            description: "A device that monitors smoke (CO2) levels in a building."
            user_id: 1
            is_active: true
            created_at: "2026-01-22T12:00:00Z"
          - id: 2
            serial_id: "QWE12345"
            name: "Humidity meter."
            description: "A device that monitors humidity(%) level in a building."
            user_id: 1
            is_active: false
            created_at: "2026-01-22T14:32:54Z"

    PaginatedTelemetry:
      type: object
      properties:
        total:
          type: integer
          example: 20
        limit:
          type: integer
          example: 5
        offset:
          type: integer
          example: 0
          # Offset = 5 means skip 5 results and display the next 5.
          # example: page 1 (result showed: 1-5), page 2 (result showed : 6-10), page 3 (result showed: 11-15), etc.
        items:
          type: array
          items:
            $ref: '#/components/schemas/Telemetry'
          example:
            - id: 1
              device_id: 1
              metric: "temperature"
              value: 18.3
              ts: "2024-04-13T18:45:37Z"
            - id: 2
              device_id: 1
              metric: "humidity"
              value: 6.73
              ts: "2024-04-13T18:50:00Z"
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 20
        limit: 5
        offset: 0
        items:
          - id: 1
            device_id: 1
            metric: "temperature"
            value: 18.3
            ts: "2024-04-13T18:45:37Z"
          - id: 2
            device_id: 1
            metric: "humidity"
            value: 6.73
            ts: "2024-04-13T18:50:00Z"

    Rule:
      type: object
      description: Business logic rule for monitoring and alerting
      properties:
        id:
          type: integer
          example: 111
        name:
          type: string
          example: "High Temperature Alert"
        description:
          type: string
          example: "Alert when temperature exceeds 30°C"
        is_active:
          type: boolean
          example: true
        condition:
          description: Rule condition in JSON format (see docs/rules.md for full schema)
          oneOf:
            - $ref: '#/components/schemas/RuleConditionThreshold'
            - $ref: '#/components/schemas/RuleConditionRate'
            - $ref: '#/components/schemas/RuleConditionComposite'  
          example:
            type: "threshold"
            operator: ">"
            value: 30
        action:
          type: object
          description: Rule action in JSON format (see docs/rules.md for full schema)
          example:
            webhook:
              url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
              enabled: true
            notification:
              channel: "email"
              enabled: true
              message: "High temperature in {device_name}: {value}°C"
        device_metric_id:
          type: integer
          description: Foreign key to DeviceMetric model
          example: 333 
      required:
        - id
        - name
        - is_active
        - condition
        - action
        - device_metric_id
      example:
        id: 1
        name: "High Temperature Alert"
        description: "Alert when temperature exceeds 30°C"
        is_active: true
        condition:
          type: "threshold"
          operator: ">"
          value: 30
        action:
          webhook:
            url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
            enabled: true
          notification:
            channel: "email"
            enabled: true
            message: "High temperature in {device_name}: {value}°C"
        device_metric_id: 1

    RuleCreate:
      type: object
      description: Data required to create a new rule
      properties:
        schema_version:
          type: integer
          description: Version of the rule schema definition
          example: 1
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: "High Temperature Alert"
        description:
          type: string
          maxLength: 1000
          example: "Alert when temperature exceeds 30°C"
        is_active:
          type: boolean
          default: true
          example: true
        condition:
          description: |
            Rule condition structure. Supported types:
            - threshold: Compare metric to value
            - rate: Count events in time window
            - composite: Combine multiple conditions with AND/OR
          oneOf:
            - $ref: '#/components/schemas/RuleConditionThreshold'
            - $ref: '#/components/schemas/RuleConditionRate'
            - $ref: '#/components/schemas/RuleConditionComposite'  
          example:
            type: "threshold"
            operator: ">"
            value: 30
        action:
          type: object
          description: Rule action in JSON format (see docs/rules.md for full schema)
          example:
            webhook:
              url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
              enabled: true
            notification:
              channel: "email"
              enabled: true
              message: "High temperature in {device_name}: {value}°C"
        device_metric_id:
          type: integer
          description: Foreign key to DeviceMetric model
          example: 1
      required:
        - name
        - condition
        - is_active
        - action
        - device_metric_id
        - schema_version
      example:
        schema_version: 1
        name: "High Temperature Alert"
        description: "Alert when temperature exceeds 30°C"
        is_active: true
        condition:
          type: "threshold"
          operator: ">"
          value: 30
        action:
          webhook:
            url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
            enabled: true
          notification:
            channel: "email"
            enabled: true
            message: "High temperature in {device_name}: {value}°C"
        device_metric_id: 1       


    RulePatch:
      type: object
      description: Partial update of rule fields
      properties:
        schema_version:
          type: integer
        name:
          type: string
        description:
          type: string
        is_active:
          type: boolean
        condition:
          type: object
        action:
          type: object
      example:
        is_active: false

    RuleConditionThreshold:
      type: object
      description: Threshold-based rule condition
      properties:
        type:
          type: string
          enum: [threshold]
          example: "threshold"
        operator:
          type: string
          enum: [">", ">=", "<", "<=", "==", "!="]
          example: ">"
        value:
          type: number
          example: 30
      required:
        - type
        - operator
        - value
      example:
        type: "threshold"
        operator: ">"
        value: 30

    RuleConditionRate:
      type: object
      description: Rate-based rule condition (event frequency)
      properties:
        type:
          type: string
          enum: [rate]
          example: "rate"
        count:
          type: integer
          minimum: 1
          description: Number of events threshold
          example: 10
        minutes:
          type: integer
          minimum: 1
          description: Time window in seconds
          example: 300
      required:
        - type
        - count
        - minutes
      example:
        type: "rate"
        count: 10
        minutes: 300

    RuleConditionComposite:
      type: object
      description: Composite rule combining multiple conditions
      properties:
        type:
          type: string
          enum: [composite]
          example: "composite"
        operator:
          type: string
          enum: [AND, OR]
          example: "AND"
        conditions:
          type: array
          description: Array of sub-conditions (threshold or rate)
          items:
            oneOf:
              - $ref: '#/components/schemas/RuleConditionThreshold'
              - $ref: '#/components/schemas/RuleConditionRate'
          minItems: 2
      required:
        - type
        - operator
        - conditions
      example:
        type: "composite"
        operator: "AND"
        conditions:
          - type: "threshold"
            operator: ">"
            value: 35
          - type: "rate"
            count: 5
            minutes: 20

    PaginatedRules:
      type: object
      properties:
        total:
          type: integer
          example: 25
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/Rule'
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 25
        limit: 20
        offset: 0
        items:
          - id: 1
            name: "High Temperature Alert"
            description: "Alert when temperature exceeds 30°C"
            is_active: true
            condition:
              type: "threshold"
              operator: ">"
              value: 30
            action:
              webhook:
                url: "https://webhook.site/a6bf3275-595d-42fd-b759-c42d74ce8c9e"
                enabled: true
              notification:
                channel: "email"
                enabled: true
                message: "High temperature in {device_name}: {value}°C"
            device_metric_id: 1
    
    RuleUpdateResponse:
      type: object
      properties:
        status:
          type: integer
        rule_id:
          type: integer
      required:
        - status
        - rule_id
      example:
        status: 200
        rule_id: 1  

    RuleEvaluateRequest:
      type: object
      properties:
        rule_id:
          type: integer
          description: Optional - evaluate only this specific rule
        device_id:
          type: integer
          description: Optional - evaluate rules only for this device
      example:
        rule_id: 12
        device_id: 5

    RuleEvaluationResult:
      type: object
      properties:
        telemetry_id:
          type: integer
          example: 101
        device_metric_id:
          type: integer
          example: 5
        device_name:
          type: string
          example: "Temperature Sensor"
        result:
          $ref: '#/components/schemas/RuleProcessorOutput'
      example:
        telemetry_id: 2
        device_metric_id: 1
        device_name: "device 1"
        result:
          telemetry_id: 2
          results:
            - rule_id: 1
              triggered: true

    RuleProcessorOutput:
      type: object
      properties:
        telemetry_id:
          type: integer
          example: 2
        results:
          type: array
          items:
            $ref: '#/components/schemas/IndividualRuleResult'
      example:
        telemetry_id: 2
        results:
          - rule_id: 1
            triggered: true      

    IndividualRuleResult:
      type: object
      properties:
        rule_id:
          type: integer
          example: 1
        triggered:
          type: boolean
          example: true
      example:
        rule_id: 1
        triggered: true    
    
    # NOTE: for future usage
    # Event:
    #   type: object
    #   description: Rule evaluation event (rule firing)
    #   properties:
    #     id:
    #       type: integer
    #       example: 11
    #     rule_id:
    #       type: integer
    #       example: 66
    #     acknowledged:
    #       type: boolean
    #       example: false
    #     timestamp:
    #       type: string
    #       format: date-time
    #       example: "2026-01-22T16:30:00Z"
    #     created_at:
    #       type: string
    #       format: date-time
    #       example: "2026-01-22T16:31:00Z"
    #     trigger_telemetry_id:
    #       type: integer
    #       nullable: true
    #       example: 11
    #   required:
    #     - id
    #     - rule_id
    #     - timestamp
    #     - created_at
    #   example:
    #     id: 1
    #     rule_id: 1
    #     acknowledged: false
    #     timestamp: "2026-01-22T16:30:00Z"
    #     created_at: "2026-01-22T16:31:00Z"
    #     trigger_telemetry_id: 1


    # PaginatedEvents:
    #   type: object
    #   properties:
    #     total:
    #       type: integer
    #       example: 50
    #     limit:
    #       type: integer
    #       example: 20
    #     offset:
    #       type: integer
    #       example: 0
    #     items:
    #       type: array
    #       items:
    #         $ref: '#/components/schemas/Event'
    #   required:
    #     - total
    #     - limit
    #     - offset
    #     - items
    #   example:
    #     total: 50
    #     limit: 20
    #     offset: 0
    #     items:
    #       - id: "550e8400-e29b-41d4-a716-446655440000"
    #         name: "High Temperature Alert"
    #         description: "Alert when temperature exceeds 30°C"
    #         is_active: true
    #         condition:
    #           type: "threshold"
    #           operator: ">"
    #           value: 30
    #         action:
    #           type: "notify"
    #           message: "User_1 temperature is overwhelming"
    #         device_metric: "123e4567-e89b-12d3-a456-426614174000"
    Event:
      type: object
      properties:
        id:
          type: integer
        timestamp:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        acknowledged:
          type: boolean
        rule:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        trigger_telemetry_id:
          type: integer
          nullable: true
        trigger_device_id:
          type: integer
          nullable: true
      example:
        id: 123
        timestamp: "2026-01-25T09:20:00+00:00"
        created_at: "2026-01-25T09:55:00+00:00"
        acknowledged: false
        rule:
          id: 2
          name: "High Temperature Alert"
        trigger_telemetry_id: 2
        trigger_device_id: 1
    #       - id: 1
    #         rule_id: 1
    #         acknowledged: false
    #         timestamp: "2026-01-22T16:30:00Z"
    #         created_at: "2026-01-22T16:31:00Z"
    #         trigger_telemetry_id: 1        
