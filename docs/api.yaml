openapi: 3.0.3

info:
  title: Devices & Telemetry & Rules API
  version: "1.5.0"
  description: |
    API for managing devices, telemetry, and rules with full CRUD support, JWT authentication,
    pagination, schema versioning, and example payloads for testing.

servers:
  - url: http://localhost:8000

tags:
  - name: Authentication
    description: Authentication endpoints
  - name: Devices
    description: CRUD operations for devices
  - name: Telemetry
    description: CRUD operations for telemetry
  - name: Rules
    description: Business logic rules and event management

paths:
  /api/auth/login:
    post:
      tags:
        - Authentication
      operationId: authLogin
      summary: Obtain JWT access token
      description: |
        Authenticates a user and returns a JWT access token.
        The token must be used in the `Authorization` header for all protected endpoints.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthLoginRequest'
            examples:
              valid_credentials:
                value:
                  username: testuser
                  password: testpassword
              admin_credentials:
                value:
                  username: adminuser
                  password: adminpassword
      responses:
        '200':
          description: JWT token issued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              required:
                - refresh_token
      responses:
        '200':
          description: Access token refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthTokenResponse'
        '400':
            description: Invalid request
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/ErrorResponse'

  /api/devices:
    get:
      tags:
        - Devices
      operationId: listDevices
      summary: List devices with pagination
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 5
          description: Maximum number of devices to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip
      responses:
        '200':
          description: List of devices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedDevices'
        '404':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Devices
      operationId: createDevice
      summary: Create a new device
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDeviceCreate'
      responses:
        '201':
          description: Device created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/devices/{id}:
    get:
      tags:
        - Devices
      operationId: getDeviceById
      summary: Get device by id
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Device found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Devices
      operationId: replaceDevice
      summary: Replace device
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDeviceCreate'
      responses:
        '200':
          description: Device updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - Devices
      summary: Partially update device
      operationId: patchDevice
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedDevicePatch'
      responses:
        '200':
          description: Device updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
        '400':
          description: Invalid patch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Devices
      summary: Delete device
      operationId: deleteDevice
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Device deleted
        '404':
          description: Device not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/telemetry:
    get:
      tags:
        - Telemetry
      summary: List telemetry records by device_id with pagination
      operationId: listTelemetry
      security:
        - BearerAuth: []
      parameters:
        - name: device_id
          in: query
          required: true
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 5
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of telemetry records
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedTelemetry'
        '404':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Telemetry
      summary: Create telemetry record
      operationId: createTelemetry
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedTelemetryCreate'
      responses:
        '201':
          description: Telemetry created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Telemetry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/telemetry/{id}:
    get:
      tags:
        - Telemetry
      summary: Get telemetry by id
      operationId: getTelemetryById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Telemetry found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Telemetry'
        '404':
          description: Telemetry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Telemetry
      summary: Replace telemetry
      operationId: replaceTelemetry
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedTelemetryCreate'
      responses:
        '200':
          description: Telemetry updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Telemetry'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Telemetry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - Telemetry
      summary: Partially update telemetry
      operationId: patchTelemetry
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionedTelemetryPatch'
      responses:
        '200':
          description: Telemetry updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Telemetry'
        '400':
          description: Invalid patch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Telemetry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Telemetry
      summary: Delete telemetry
      operationId: deleteTelemetry
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Telemetry deleted
        '404':
          description: Telemetry not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/rules:
    get:
      tags:
        - Rules
      operationId: listRules
      summary: List rules with pagination and filters
      description: |
        Returns a paginated list of rules.
        Supports filtering by activation status and action type.
        Used to browse, search, and manage existing rules.
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of rules to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of items to skip
        - name: is_active
          in: query
          schema:
            type: boolean
          description: Filter by enabled status
        - name: action
          in: query
          schema:
            type: object
          description: Filter by action type in JSON format
          example:
            type: "notify"
      responses:
        '200':
          description: List of rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedRules'
              examples:
                default:
                  summary: Paginated list of rules
                  value:
                    total: 3
                    limit: 20
                    offset: 0
                    items:
                      - id: "550e8400-e29b-41d4-a716-446655440000"
                        name: "High Temperature Alert"
                        description: "Alert when temperature exceeds 30°C"
                        is_active: true
                        condition:
                          type: "threshold"
                          operator: ">"
                          value: 30
                        action:
                          type: "notify"
                        device_metric: "123e4567-e89b-12d3-a456-426614174000"
                      - id: "660e8400-e29b-41d4-a716-446655440111"
                        name: "Low Humidity Alert"
                        description: "Alert when humidity drops below 20%"
                        is_active: true
                        condition:
                          type: "threshold"
                          operator: "<"
                          value: 20
                        action:
                          type: "notify"
                        device_metric: "123e4567-e29b-12d3-a456-426614174001"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_filter:
                  summary: Invalid query parameters
                  value:
                    code: 400
                    message: "Invalid filter parameters"
    post:
      tags:
        - Rules
      operationId: createRule
      summary: Create a new rule
      description:  |
        Creates a new rule and persists it for future evaluation.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreate'
            examples:
              threshold_rule:
                summary: Temperature threshold rule
                value:
                  name: "High Temperature Alert"
                  description: "Alert when temperature exceeds 30°C"
                  is_active: true
                  condition:
                    type: "threshold"
                    operator: ">"
                    value: 30
                  action: 
                    type: "notify"
                    message: "some info"
                  device_metric: "123e4567-e89b-12d3-a456-426614174000"
              rate_rule:
                summary: Event rate rule
                value:
                  name: "Too Many Errors"
                  description: "Alert when more than 10 errors occur in 5 minutes"
                  is_active: true
                  condition:
                    type: "rate"
                    count: 10
                    minutes: 300
                  action: 
                    type: "webhook"
                    message: "some info"
                  device_metric: "123e4567-e89b-12d3-a456-426614174000"
              composite_rule:
                summary: Composite AND rule
                value:
                  name: "Critical System State"
                  description: "Alert when temperature high AND humidity low"
                  is_active: true
                  condition:
                    type: "composite"
                    operator: "AND"
                    conditions:
                      - type: "threshold"
                        operator: ">"
                        value: 35
                        device_metric: "123e4567-e89b-12d3-a456-426614174000"
                      - type: "threshold"
                        device_metric: "123e4567-e89b-12d3-a456-426614174111"
                        operator: "<"
                        value: 20
                  action:
                    type: "notify"
                    message: "some info"
                  device_metric: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        '201':
          description: Rule created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                created:
                  summary: Created rule with full schema
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "High Temperature Alert"
                    description: "Alert when temperature exceeds 30°C"
                    is_active: true
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 30
                    action:
                      type: "notify"
                      message: "User_1 temperature is overwhelming"
                    device_metric: "123e4567-e89b-12d3-a456-426614174000"  
        '400':
          description: Invalid rule definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_condition:
                  summary: Invalid condition definition
                  value:
                    code: 400
                    message: "Invalid rule condition: Unsupported operator"     

  /api/rules/{id}:
    get:
      tags:
        - Rules
      operationId: getRuleById
      summary: Get rule by ID
      description: |
        Returns full rule details by its unique identifier.
        Includes condition definition, action configuration, and current state.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Rule UUID   
      responses:
        '200':
          description: Rule found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Updated Rule"
                    is_active: false
                    action: 
                      type: "notify"
                      message: "some info" 
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric: "550e8400-e29b-41d4-a716-446655440000"     
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400   
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    put:
      tags:
        - Rules
      operationId: replaceRule
      summary: Replace rule completely
      description: |
        Replaces the entire rule definition.
        All rule fields must be provided in the request body.
        Missing fields will be overwritten with new values.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleCreate'
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    id: "550e8411-e29b-41d4-a716-446655440000"
                    name: "Updated Rule"
                    is_active: false
                    action: 
                      type: "notify"
                      message: "some message"
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric: "550e8412-e29b-41d4-a716-446655440000"       
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    patch:
      tags:
        - Rules
      summary: Partially update rule
      description: |
        Updates one or more fields of an existing rule.
        Only provided fields are modified; all others remain unchanged.
      operationId: patchRule
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RulePatch'
            examples:
              replace_rule:
                summary: Full rule replacement
                value:
                  name: "Updated Rule"
                  is_active: false
                  condition:
                    type: "threshold"
                    operator: "<"
                    value: 10
                  device_metric: "123e4567-e89b-12d3-a456-426614174000"
                  action: 
                    type: "notify"
                    message: "info"
  
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                updated:
                  summary: Updated rule
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Updated Rule"
                    is_active: false
                    action: 
                      type: "notify"
                      message: "info"
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric: "550e8400-e29b-41d4-a716-446655440000"    
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_payload:
                  summary: Invalid rule payload
                  value:
                    message: "Invalid rule definition"
                    code: 400
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    message: "Rule not found"
                    code: 404
    delete:
      tags:
        - Rules
      summary: Delete rule
      description: |
        Permanently deletes a rule.
        Deleted rules are no longer evaluated and cannot be restored.
      operationId: deleteRule
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Rule deleted
          content:
            application/json:
              examples:
                no_content:
                  summary: No response body
                  value: {}
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule does not exist
                  value:
                    code: 404
                    message: "Rule not found"

  /api/rules/{id}/enable:
    post:
      tags:
        - Rules
      summary: Enable a rule
      operationId: enableRule
      description: Activates a rule so it will be evaluated during rule processing
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Rule state changed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                enabled:
                  summary: Rule enabled
                  value:
                    id: "550e8400-e29b-41d4-a716-446655448000"
                    name: "Rule name"
                    is_active: true
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric: "550e8400-e29b-41d4-a716-446655440900"
                    action:
                      type: "notify"
                      message: "123"
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    code: 404
                    message: "Rule not found"

  /api/rules/{id}/disable:
    post:
      tags:
        - Rules
      summary: Disable a rule
      operationId: disableRule
      description: Deactivates a rule so it will not be evaluated
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Rule state changed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
              examples:
                enabled:
                  summary: Rule enabled
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    name: "Rule name"
                    is_active: true
                    condition:
                      type: "threshold"
                      operator: ">"
                      value: 13
                    device_metric: "550e8400-e29b-41d4-a716-446655440000"
                    action:
                      type: "notify"
                      message: "123" 
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    code: 404
                    message: "Rule not found"

  /api/rules/evaluate:
    post:
      tags:
        - Rules
      summary: Manually trigger rule evaluation
      operationId: evaluateRules
      description: |
        Triggers manual evaluation of all enabled rules for debugging and demo purposes.
        This endpoint runs the rule processor immediately instead of waiting for the scheduled task.
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleEvaluateRequest'
            examples:
              evaluate_example:
                summary: Evaluate telemetry data against rules
                value:
                  device_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Evaluation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleEvaluateResponse'
              examples:
                success:
                  summary: Rules matched
                  value:
                    device_id: "550e8400-e29b-41d4-a716-446655440000"
                    trigger_telemetry_id: "123e4567-e89b-12d3-a456-426614174000"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  summary: Invalid telemetry payload
                  value:
                    code: 400
                    message: "Telemetry value missing"
  
  /api/rules/{id}/events:
    get:
      tags:
        - Rules
      summary: Get rule evaluation history
      operationId: getRuleEvents
      description: Returns all events (rule firings) for a specific rule with pagination
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: from_date
          in: query
          schema:
            type: string
            format: date-time
          description: Filter events from this date
        - name: to_date
          in: query
          schema:
            type: string
            format: date-time
          description: Filter events until this date
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedEvents'
              examples:
                success:
                  summary: Rule events
                  value:
                    total: 1
                    limit: 20
                    offset: 0
                    items:
                      - id: "550e8400-e29b-41d4-a716-446655440001"
                        rule_id: "550e8400-e29b-41d4-a716-446655440002"
                        acknowledged: false
                        timestamp: "2026-01-22T16:30:00Z"
                        created_at: "2026-01-22T16:31:00Z"
                        trigger_telemetry_id: "550e8400-e29b-41d4-a716-446655440003"
                        trigger_value:
                          metric_value: 35.2
                        trigger_device_metric_id: "550e8400-e29b-41d4-a716-446655440001"
        '404':
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Rule not found
                  value:
                    code: 404
                    message: "Rule not found"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token containing claims:
        - sub: authenticated user id
        - scope: granted permissions (e.g., devices:read)
        - role: user | admin
        - exp: expiration timestamp

  schemas:
    Device:
      type: object
      properties:
        id:
          type: integer
          example: 1
        serial_id:
          type: string
          example: "ABC12345"
        name:
          type: string
          example: "Smoke detector."
        description:
          type: string
          example: "A device that monitors smoke (CO2) levels in a building."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2026-01-22T12:00:00Z"
      required:
        - id
        - serial_id
        - name
        - user_id
        - is_active
        - created_at
      example:
        id: 1
        serial_id: "ABC12345"
        name: "Smoke detector."
        description: "A device that monitors smoke (CO2) levels in a building."
        user_id: 1
        is_active: true
        created_at: "2026-01-22T12:00:00Z"

    DeviceCreate:
      type: object
      properties:
        serial_id:
          type: string
          example: "DEF12345"
        name:
          type: string
          example: "Digital thermometer."
        description:
          type: string
          example: "Monitors indoor temperature."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: false
      required:
        - serial_id
        - name
        - user_id
        - is_active
      example:
        serial_id: "ABC12345"
        name: "Digital thermometer."
        description: "Monitors indoor temperature."
        user_id: 1
        is_active: false

    DevicePatch:
      type: object
      properties:
        serial_id:
          type: string
          example: "ABC12345"
        name:
          type: string
          example: "Smoke detector."
        description:
          type: string
          example: "New description."
        user_id:
          type: integer
          example: 1
        is_active:
          type: boolean
          example: true
      example:
        serial_id: "ABC12345"
        name: "Smoke detector."
        description: "New description."
        user_id: 1
        is_active: true

    VersionedDeviceCreate:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1"
        device:
          $ref: '#/components/schemas/DeviceCreate'
      required:
        - schema_version
        - device
      example:
        schema_version: "v1"
        device:
          serial_id: "DEF12345"
          name: "Digital thermometer."
          description: "Monitors indoor temperature."
          user_id: 1
          is_active: false

    VersionedDevicePatch:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1"
        device:
          $ref: '#/components/schemas/DevicePatch'
      required:
        - schema_version
        - device
      example:
        schema_version: "v1"
        device:
          name: "Updated smoke detector name."
          description: "Updated description."
          is_active: true

    Telemetry:
      type: object
      properties:
        id:
          type: integer
          example: 1
        device_id:
          type: integer
          example: 1
        key:
          type: string
          example: "temperature"
        value:
          type: number
          example: 18.3
        created_at:
          type: string
          format: date-time
          example: "2024-04-13T18:45:37Z"
      required:
        - id
        - device_id
        - key
        - value
        - created_at
      example:
        id: 1
        device_id: 1
        key: "temperature"
        value: 18.3
        created_at: "2024-04-13T18:45:37Z"

    TelemetryCreate:
      type: object
      properties:
        device_id:
          type: integer
          example: 1
        key:
          type: string
          example: "humidity"
        value:
          type: number
          example: 25.43
      required:
        - device_id
        - key
        - value
      example:
        device_id: 1
        key: "humidity"
        value: 25.43

    TelemetryPatch:
      type: object
      properties:
        key:
          type: string
          example: "temperature"
        value:
          type: number
          example: 24.3
      example:
        key: "temperature"
        value: 24.3

    VersionedTelemetryCreate:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1"
        telemetry:
          $ref: '#/components/schemas/TelemetryCreate'
      required:
        - schema_version
        - telemetry
      example:
        schema_version: "v2"
        telemetry:
          device_id: 1
          key: "humidity"
          value: 25.43

    VersionedTelemetryPatch:
      type: object
      properties:
        schema_version:
          type: string
          example: "v1.0"
        telemetry:
          $ref: '#/components/schemas/TelemetryPatch'
      required:
        - schema_version
        - telemetry
      example:
        schema_version: "v1.2"
        telemetry:
          key: "temperature"
          value: 24.3

    AuthLoginRequest:
      type: object
      properties:
        username:
          type: string
          example: testuser
        password:
          type: string
          format: password
          example: testpassword
      required:
        - username
        - password
      example:
        username: testuser
        password: testpassword

    AuthTokenResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          example: bearer
        expires_in:
          type: string
          format: date-time
          example: "2026-01-22T17:00:00Z"
      required:
        - access_token
        - token_type
        - expires_in
      example:
        access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type: bearer
        expires_in: "2026-01-22T17:00:00Z"

    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
      example:
        code: 404
        message: "Resource not found"

    PaginatedDevices:
      type: object
      properties:
        total:
          type: integer
          example: 12
        limit:
          type: integer
          example: 5
        offset:
          type: integer
          example: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/Device'
          example:
            [
              {
                id: 1,
                serial_id: "ABC12345",
                name: "Smoke detector.",
                description: "A device that monitors smoke (CO2) levels in a building.",
                user_id: 1,
                is_active: true,
                created_at: "2026-01-22T12:00:00Z"
              },
              {
                id: 2,
                serial_id: "QWE12345",
                name: "Humidity meter.",
                description: "A device that monitors humidity(%) level in a building.",
                user_id: 1,
                is_active: false,
                created_at: "2026-01-22T14:32:54Z"
              }
            ]
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 12
        limit: 5
        offset: 0
        items:
          - id: 1
            serial_id: "ABC12345"
            name: "Smoke detector."
            description: "A device that monitors smoke (CO2) levels in a building."
            user_id: 1
            is_active: true
            created_at: "2026-01-22T12:00:00Z"
          - id: 2
            serial_id: "QWE12345"
            name: "Humidity meter."
            description: "A device that monitors humidity(%) level in a building."
            user_id: 1
            is_active: false
            created_at: "2026-01-22T14:32:54Z"

    PaginatedTelemetry:
      type: object
      properties:
        total:
          type: integer
          example: 20
        limit:
          type: integer
          example: 5
        offset:
          type: integer
          example: 0
          # Offset = 5 means skip 5 results and display the next 5.
          # example: page 1 (result showed: 1-5), page 2 (result showed : 6-10) , page 3 (result showed: 11-15), and etc.
        items:
          type: array
          items:
            $ref: '#/components/schemas/Telemetry'
          example: 
              [
              {
                id: 1,
                device_id: 1,
                key: "temperature",
                value: 18.3,
                created_at: "2024-04-13T18:45:37Z"
              },
              {
                id: 2,
                device_id: 1,
                key: "humidity",
                value: 6.73,
                created_at: "2022-07-01T11:23:33Z"
              }
            ]
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 20
        limit: 5
        offset: 0
        items:
          - id: 1
            device_id: 1
            key: "temperature"
            value: 18.3
            created_at: "2024-04-13T18:45:37Z"
          - id: 2
            device_id: 1
            key: "humidity"
            value: 6.73
            created_at: "2022-07-01T11:23:33Z"

    Rule:
      type: object
      description: Business logic rule for monitoring and alerting
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "High Temperature Alert"
        description:
          type: string
          example: "Alert when temperature exceeds 30°C"
        is_active:
          type: boolean
          example: true
        condition:
          type: object
          description: Rule condition in JSON format (see docs/rules.md for full schema)
          example:
            type: "threshold"
            operator: ">"
            value: 30
        action:
          type: object
          description: Rule action in JSON format (see docs/rules.md for full schema)
          example:
            type: "notify"
            message: "User_1 temperature is overwhelming"
        device_metric:
          type: string
          format: uuid
          description: Foreign key to DeviceMetric model
          example: "123e4567-e89b-12d3-a456-426614174000" 
      required:
        - id
        - name
        - is_active
        - condition
        - action
        - device_metric
      example:
        id: "550e8400-e29b-41d4-a716-446655440000"
        name: "High Temperature Alert"
        description: "Alert when temperature exceeds 30°C"
        is_active: true
        condition:
          type: "threshold"
          operator: ">"
          value: 30
        action:
          type: "notify"
          message: "User_1 temperature is overwhelming"
        device_metric: "123e4567-e89b-12d3-a456-426614174000"  

    RuleCreate:
      type: object
      description: Data required to create a new rule
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: "High Temperature Alert"
        description:
          type: string
          maxLength: 1000
          example: "Alert when temperature exceeds 30°C"
        is_active:
          type: boolean
          default: true
          example: true
        condition:
          type: object
          description: |
            Rule condition structure. Supported types:
            - threshold: Compare metric to value
            - rate: Count events in time window
            - composite: Combine multiple conditions with AND/OR
          example:
            type: "threshold"
            operator: ">"
            value: 30
        action:
          type: object
          example: 
            type: "notify"
        device_metric:
          type: string
          format: uuid
          description: Foreign key to DeviceMetric model
          example: "123e4567-e89b-12d3-a456-426614174000" 
      required:
        - name
        - condition
        - is_active
        - action
        - device_metric
      example:
        name: "High Temperature Alert"
        description: "Alert when temperature exceeds 30°C"
        is_active: true
        condition:
          type: "threshold"
          operator: ">"
          value: 30
        action:
          type: "notify"
          message: "User_1 temperature is overwhelming"
        device_metric: "123e4567-e89b-12d3-a456-426614174000"  

    RulePatch:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        is_active:
          type: boolean
        condition:
          type: object
        action:
          type: object
        device_metric:
          type: string
          format: uuid
      example:
        name: "High Temp Updated"
        description: "Alert if > 32°C"
        is_active: false
        condition:
          type: "threshold"
          operator: ">"
          value: 32
        action:
          type: "notify"
        device_metric: "123e4567-e89b-12d3-a456-426614174000"    

    PaginatedRules:
      type: object
      properties:
        total:
          type: integer
          example: 25
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/Rule'
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 25
        limit: 20
        offset: 0
        items:
          - id: "550e8400-e29b-41d4-a716-446655440000"
            name: "High Temperature Alert"
            description: "Alert when temperature exceeds 30°C"
            is_active: true
            condition:
              type: "threshold"
              operator: ">"
              value: 30
            action:
              type: "notify"
              message: "User_1 temperature is overwhelming"
            device_metric: "123e4567-e89b-12d3-a456-426614174000"
    
    RuleEvaluateRequest:
      type: object
      properties:
        device_id:
          type: string
          format: uuid
      required:
        - device_id
      example:
        device_id: "550e8400-e29b-41d4-a716-446655440000"  
    
    RuleEvaluateResponse:
      type: object
      properties:
        device_id:
          type: string
          format: uuid
        trigger_telemetry_id:
          type: string
          format: uuid
      required:
        - device_id
        - trigger_telemetry_id
      example:
        device_id: "550e8400-e29b-41d4-a716-446655440000"
        trigger_telemetry_id: "766e8400-a33b-11d4-a716-446655441100"   
    
    Event:
      type: object
      description: Rule evaluation event (rule firing)
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        rule_id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        acknowledged:
          type: boolean
          example: false
        timestamp:
          type: string
          format: date-time
          example: "2026-01-22T16:30:00Z"
        created_at:
          type: string
          format: date-time
          example: "2026-01-22T16:31:00Z"
        trigger_telemetry_id:
          type: string
          format: uuid
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440001"
        trigger_value:
          type: object
          nullable: true
          description: Copy of telemetry value at trigger time
          example:
            metric_value: 35.2
        trigger_device_metric_id:
          type: string
          format: uuid
          nullable: true
          example: "550e8400-e29b-41d4-a716-446655440001"
      required:
        - id
        - rule_id
        - timestamp
        - created_at
      example:
        id: "550e8400-e29b-41d4-a716-446655440001"
        rule_id: "550e8400-e29b-41d4-a716-446655440001"
        acknowledged: false
        timestamp: "2026-01-22T16:30:00Z"
        created_at: "2026-01-22T16:31:00Z"
        trigger_telemetry_id: "550e8400-e29b-41d4-a716-446655440001"
        trigger_value:
          metric_value: 35.2
        trigger_device_metric_id: "550e8400-e29b-41d4-a716-446655440009"

    PaginatedEvents:
      type: object
      properties:
        total:
          type: integer
          example: 50
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0
        items:
          type: array
          items:
            $ref: '#/components/schemas/Event'
      required:
        - total
        - limit
        - offset
        - items
      example:
        total: 50
        limit: 20
        offset: 0
        items:
          - id: "550e8400-e29b-41d4-a716-446655440001"
            rule_id: "550e8400-e29b-41d4-a716-446655440001"
            acknowledged: false
            timestamp: "2026-01-22T16:30:00Z"
            created_at: "2026-01-22T16:31:00Z"
            trigger_telemetry_id: "550e8400-e29b-41d4-a716-446655440001"
            trigger_value:
              metric_value: 35.2
            trigger_device_metric_id: "550e8400-e29b-41d4-a716-446655440011"
          